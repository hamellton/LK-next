import React, { useEffect, useState } from "react";
import ApplyCouponBar from "../../../Common/ApplyCouponBar/ApplyCouponBar.component";

import { CommonSection, FirstSection, SecondSection } from "./LkCash.styles";
import { LkCashTypes } from "./LkCash.types";


const LkCash = ({ cartData, applyGv, localeData, isRTL = false, isGuestUser, showSignin, newCartOfferDesign, bestOffers, bankOffers, mergedWithLKCash = false }:LkCashTypes)=>{
	const [applyCoupon,setApplyCoupon] = useState(false);
	const [error,setError] = useState("");

	const applyCouponHandler=()=>{
		setApplyCoupon(true);
	};

	const removeCouponHandler = (e:any)=>{
		e.stopPropagation();
		applyGv(cartData?.appliedGv?.code, "remove");
	};

	useEffect(() => {
		if (cartData?.couponError) {
			setError("You have entered an invalid coupon code !");
		}
		if (cartData?.appliedGv?.code) setApplyCoupon(false);
	}, [cartData?.couponError, cartData?.appliedGv?.code]);

	const onApplyCouponClick = () => {
		if(isGuestUser) {
			if(typeof showSignin === "function") showSignin();
		} else {
			applyCouponHandler();
		}
	};
	const currencyCode = (code: string) => {
		if(code === "USD") return "$";
		if(code==="SGD") return "$";
		else return code;
	};
	return <div>
		<CommonSection onClick={!cartData?.isGvApplied ? onApplyCouponClick: ()=> null} mergedWithLKCash={mergedWithLKCash}>
			<FirstSection isRTL={isRTL}>
				<span id="coupon_code">{cartData?.isGvApplied
					? `${cartData?.appliedGv?.code}`
					: localeData?.APPLY_COUPON || "Apply Coupon"}
				</span>
				{cartData?.isGvApplied && <span id="coupon_status">{localeData?.APPLIED}</span>}
				<div>{cartData?.isGvApplied ? 
					<> 
						<span>{localeData?.YOU_HAVE_SAVED || "You have saved"}</span>
						{currencyCode(cartData?.currencyCode) === "INR"?<span>&#8377;</span> : currencyCode(cartData?.currencyCode)}
						<span>{cartData?.appliedGv?.amount} {localeData?.ON_YOUR_FINAL_BILL || "on your final bill"}
						</span>
					</> : localeData?.SEE_AVAILABLE_OFFERS || "See available offers and cashbacks" }</div>
			</FirstSection>
			<SecondSection isRTL={isRTL}>
				{!cartData?.isGvApplied && <img
					alt="right arrow"
					src="https://static1.lenskart.com/media/desktop/img/DesignStudioIcons/RightArrow.svg"
				/>}
				{cartData?.isGvApplied && <div onClick={(e)=>removeCouponHandler(e)}>{localeData.REMOVE}</div>}
			</SecondSection>
		</CommonSection>

		<ApplyCouponBar 
			mobileView={true}
			showSidebar={applyCoupon}
			applicableGvs={cartData?.applicableGvs}
			sorryNoCoupon={localeData?.SORRY_NO_COUPON}
			errMsg={error}
			applyGvHandler={applyGv} 
			setShowSidebar={setApplyCoupon} 
			setErrorMsg={setError}
			appliedCoupon={cartData?.appliedGv?.code}		
			isRTL={isRTL}
			textCapitalize={true}
			dataLocale={localeData}
			newCartOfferDesign={newCartOfferDesign}
			bestOffers={bestOffers}
			bankOffers={bankOffers}
		>
		</ApplyCouponBar>
	</div>;
};

export { LkCash };