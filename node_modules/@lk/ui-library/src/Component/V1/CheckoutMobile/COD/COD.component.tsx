import React, { useState, useEffect } from "react";
import BottomSheet from "../../../Common/BottomSheet/BottomSheet.component";
import CommonSection from "../MorePaymentOptions/Common/CommonSection.component";
import { CashOnDelivery, CODBottomSheet, CaptchaSection, Captcha, Margin } from "./COD.styles";
import FloatingLabelInput from "../../../Common/FloatingLabelInput";
import { kindENUM, ThemeENUM, TypographyENUM } from "../../../../Types/general";
import Button from "../../Button";
import { CODTypes } from "./COD.types";
import { ErrorMessage } from "../StoreCredit/StoreCredit.styles";


export default function COD({ onSubmit, isCaptchaEnabled, captchaImageUrl, captchaValue, loadCaptcha, dataLocale, label, img, borderVisible, abandonedLeadsFunction }:CODTypes){
	const [openCOD,setOpenCOD] = useState(false);
	const [error,setError] = useState(false);
	const [userCaptcha, setUserCaptcha] = useState("");

	const [errorMessage,setErrorMessage] = useState("");

	useEffect(() => {
		if(typeof loadCaptcha === "function" && openCOD && isCaptchaEnabled) loadCaptcha();
	}, [openCOD, loadCaptcha, isCaptchaEnabled]);
	const submitHandler = (e: any) => {

		if(isCaptchaEnabled && (userCaptcha === captchaValue)) {
			setError(false);
			onSubmit(e);
		}
		else setError(true);
	};

	function openCODHandler(){
		setOpenCOD(!openCOD);
	}

	function handleErrorCaptcha(e:string){
		if(e.trim() === ""){
			setErrorMessage("This is required");
			setError(true);
		} else if (userCaptcha !== captchaValue){
			setErrorMessage(dataLocale.PLEASE_ENTER_CAPTCHA);
			setError(true);
		} else{
			setErrorMessage("");
			setError(false);
		}
	}

	useEffect(()=> ()=> {
		setErrorMessage("");
		setError(false);
	},[openCOD]);

	return <div>
		<CashOnDelivery onClick={() => {
			openCODHandler();
			abandonedLeadsFunction();
		}} borderVisible={borderVisible}>
			<CommonSection src={img || "https://static.lenskart.com/media/desktop/img/DesignStudioIcons/COD.svg" } name={label || dataLocale?.PAY_WITH_CASH} content={dataLocale?.PAY_WITH_CASH}></CommonSection>
		</CashOnDelivery>

		<BottomSheet closebottomSheet={openCODHandler} show={openCOD} onBackdropClick={openCODHandler}>
			<CODBottomSheet>
				<h2>{dataLocale?.CASH_ON_DELIVERY}</h2>
				<CaptchaSection>
					<Captcha src={captchaImageUrl}/>
					<a onClick={loadCaptcha}>{dataLocale?.CHANGE_IMAGE}</a>
				</CaptchaSection>
				<FloatingLabelInput hasError={error} hasErrorIcon={false} label={dataLocale?.ENTER_CODE_SHOWN_ABOVE} width="100%" font={TypographyENUM.lkSansRegular} type="text" getInputValue={setUserCaptcha} handleError={((e)=>handleErrorCaptcha(e.target.value))} maxLength={10}></FloatingLabelInput>
				{errorMessage && <ErrorMessage>{errorMessage}</ErrorMessage>}
				<Margin></Margin>
				<Button
					id={dataLocale?.VERIFY_AND_PLACE_ORDER}
					text={dataLocale?.VERIFY_AND_PLACE_ORDER}
					theme={ThemeENUM.primary}
					kind={kindENUM.background}
					font={TypographyENUM.lkSansBold}
					width="100"
					// disabled={props.hasError}
					onClick={submitHandler}
				></Button>

			</CODBottomSheet>
		</BottomSheet>
	</div>;
}
