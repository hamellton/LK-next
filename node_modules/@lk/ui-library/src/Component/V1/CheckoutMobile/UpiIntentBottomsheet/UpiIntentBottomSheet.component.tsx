import React, { useEffect } from "react";
import { ThemeENUM, TypographyENUM } from "../../../../Types/general";
import BottomSheet from "../../../Common/BottomSheet/BottomSheet.component";
import Button from "../../Button";
import { kindENUM } from "../../Button/Button.types";
import { IntentSheetContainer, IntentSheetContent, IntentSheetHeader, LoaderBlock, Note, NoteSection } from "./UpiIntentBottomSheet.styles";
import { UpiIntentBottomSheetProps } from "./UpiIntentBottomSheet.types";

let runStatusCheck: NodeJS.Timeout;
function UpiIntentBottomSheet({
	show,
	dataLocale,
	onCancel,
	configData,
	getUpiTransactionStatus,
	upiTransactionStatus,
	orderId,
	showStatusScreen,
	setShowStatusScreen,
	setStatusData,
	successData,
	failureData
}: UpiIntentBottomSheetProps) {
	const cartConfig = configData &&
		configData?.CART_UPI_CONFIG && JSON.parse(configData.CART_UPI_CONFIG as string);
	// const duration = (cartConfig?.timerLoaderDelay && JSON.parse(cartConfig.timerLoaderDelay)) || 300;
	const checkStatusDelay = (cartConfig?.upiPaymentStatusRequest && JSON.parse(cartConfig.upiPaymentStatusRequest)) || 5000;

	useEffect(() => {
		if (getUpiTransactionStatus) {
			getUpiTransactionStatus(orderId);
		}
		return () => {
			clearTimeout(runStatusCheck);
		};
	}, []);

	useEffect(() => {
		if (upiTransactionStatus === "PENDING") {
			runStatusCheck = setTimeout(() => {
				getUpiTransactionStatus(orderId);
			}, checkStatusDelay);
		} else if (!showStatusScreen && upiTransactionStatus && upiTransactionStatus !== "PENDING") {
			clearTimeout(runStatusCheck);
			if (upiTransactionStatus === "SUCCESS") {
				setStatusData(successData);
				setShowStatusScreen(true);
			} else {
				setStatusData(failureData);
				setShowStatusScreen(true);
			}
		}
	}, [upiTransactionStatus]);

	return (
		<BottomSheet
			show={show}
			closebottomSheet={() => null}
			showCrossIcon={false}
			top={"0px"}
			borderRadius={"0px"}
		>
			<IntentSheetContainer>
				<IntentSheetContent>
					<IntentSheetHeader>
						{dataLocale?.SELECT_APP_FROM_BELOW_LIST as string}
					</IntentSheetHeader>
					<LoaderBlock>
						<img
							alt="upi loader"
							src="https://static.lenskart.com/media/mobile/images/upi/upi-loader.gif"
						/>
					</LoaderBlock>
				</IntentSheetContent>
				<NoteSection>
					<Note>
						<>
							<strong>{dataLocale?.NOTE as string}:</strong>{" "}
							{dataLocale?.DONT_CLOSE_TILL_TRANSACTION_COMPLETE}
						</>
					</Note>
					<Button
						id="Cancel-Payment"
						text={dataLocale?.CANCEL_PAYMENT as string}
						font={TypographyENUM.lkSansBold}
						onClick={onCancel}
						theme={ThemeENUM.secondary}
						kind={kindENUM.tertiary}
					/>
				</NoteSection>
			</IntentSheetContainer>
		</BottomSheet>
	);
}

export { UpiIntentBottomSheet };